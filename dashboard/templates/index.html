<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenLLM Control Center</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='img/site-icon.svg') }}">
    <style>
        :root {
            --bg:#0b1120;
            --sidebar:#0f172a;
            --panel:#111c2e;
            --panel-border:#1f2a3e;
            --panel-hover:#16213e;
            --text:#f8fafc;
            --muted:#94a3b8;
            --accent:#7c3aed;
            --accent-soft:#6366f1;
            --success:#10b981;
            --danger:#ef4444;
            --warning:#f59e0b;
        }
        * {
            margin:0;
            padding:0;
            box-sizing:border-box;
        }
        html {
            scroll-behavior:smooth;
        }
        body {
            font-family:'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background:var(--bg);
            color:var(--text);
            display:flex;
            min-height:100vh;
        }
        a {
            color:inherit;
            text-decoration:none;
        }
        button {
            font-family:inherit;
        }
        .hidden {
            display:none !important;
        }
        .provider-config-form {
            transition: all 0.3s ease;
            overflow: hidden;
        }
        /* Tooltip system: use data-tooltip="..." on elements */
        [data-tooltip] {
            position: relative;
            cursor: help;
        }
        [data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: calc(100% + 10px);
            background: rgba(17,28,46,0.95);
            color: var(--text);
            padding:6px 10px;
            border-radius:8px;
            font-size:12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.12s ease, transform 0.12s ease;
            box-shadow: 0 6px 18px rgba(2,6,23,0.6);
            z-index: 2100;
        }
        [data-tooltip]::before {
            content: '';
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: calc(100% + 4px);
            width: 8px;
            height: 8px;
            background: rgba(17,28,46,0.95);
            transform-origin: center;
            opacity:0;
            z-index:2100;
            transform: translateX(-50%) rotate(45deg);
        }
        [data-tooltip]:hover::after,
        [data-tooltip].tooltip-visible::after {
            opacity:1;
            transform: translateX(-50%) translateY(0);
        }
        [data-tooltip]:hover::before,
        [data-tooltip].tooltip-visible::before {
            opacity:1;
        }
        .hamburger {
            display:none;
            position:fixed;
            top:20px;
            left:20px;
            z-index:1001;
            width:44px;
            height:44px;
            background:var(--sidebar);
            border:1px solid var(--panel-border);
            border-radius:12px;
            cursor:pointer;
            flex-direction:column;
            align-items:center;
            justify-content:center;
            gap:5px;
            transition:all 0.3s ease;
        }
        .hamburger:hover {
            background:var(--panel-hover);
        }
        .hamburger span {
            display:block;
            width:20px;
            height:2px;
            background:var(--text);
            border-radius:2px;
            transition:all 0.3s ease;
        }
        .hamburger.active span:nth-child(1) {
            transform:rotate(45deg) translate(5px, 5px);
        }
        .hamburger.active span:nth-child(2) {
            opacity:0;
        }
        .hamburger.active span:nth-child(3) {
            transform:rotate(-45deg) translate(6px, -6px);
        }
        .mobile-overlay {
            display:none;
            position:fixed;
            inset:0;
            background:rgba(0,0,0,0.5);
            z-index:999;
            opacity:0;
            transition:opacity 0.3s ease;
            pointer-events:none;
        }
        .mobile-overlay.active {
            opacity:1;
            pointer-events:auto;
        }
        .app-shell {
            display:flex;
            width:100%;
        }
        .sidebar {
            width:260px;
            background:var(--sidebar);
            border-right:1px solid var(--panel-border);
            padding:32px 24px;
            display:flex;
            flex-direction:column;
            gap:28px;
            position:sticky;
            top:0;
            height:100vh;
            overflow-y:auto;
            transition:transform 0.3s ease;
        }
        .sidebar::-webkit-scrollbar {
            width:6px;
        }
        .sidebar::-webkit-scrollbar-thumb {
            background:rgba(148,163,184,0.3);
            border-radius:999px;
        }
        .sidebar-brand {
            display:flex;
            align-items:center;
            gap:14px;
        }
        .brand-icon {
            width:42px;
            height:42px;
            border-radius:12px;
            background:linear-gradient(135deg, var(--accent-soft), var(--accent));
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:22px;
        }
        .sidebar-brand-title {
            font-size:20px;
            font-weight:700;
            color:#f8fafc;
        }
        .sidebar-brand-subtitle {
            font-size:12px;
            text-transform:uppercase;
            letter-spacing:0.16em;
            color:var(--muted);
            margin-top:2px;
        }
        .sidebar-status {
            display:flex;
            align-items:center;
            gap:12px;
            padding:14px 16px;
            border-radius:12px;
            background:rgba(148,163,184,0.08);
        }
        .status-label {
            font-size:11px;
            letter-spacing:0.12em;
            text-transform:uppercase;
            color:var(--muted);
        }
        .status-text {
            font-size:14px;
            font-weight:600;
        }
        .status-dot {
            width:10px;
            height:10px;
            border-radius:50%;
            background:var(--danger);
        }
        .status-dot.online {
            background:var(--success);
        }
        .sidebar-nav {
            display:flex;
            flex-direction:column;
            gap:6px;
        }
        .nav-link {
            display:flex;
            align-items:center;
            gap:12px;
            padding:10px 14px;
            border-radius:12px;
            font-weight:500;
            color:var(--muted);
            transition:all 0.2s ease;
            touch-action:manipulation;
            -webkit-tap-highlight-color:transparent;
        }
        .nav-link:hover {
            color:var(--text);
            background:rgba(99,102,241,0.12);
        }
        .nav-link.active {
            background:linear-gradient(135deg, var(--accent-soft), var(--accent));
            color:#ffffff;
            box-shadow:0 18px 35px rgba(99,102,241,0.3);
        }
        .marketplace-link {
            margin-top:auto;
            display:flex;
            align-items:center;
            gap:10px;
            justify-content:center;
            padding:12px 18px;
            border-radius:12px;
            background:rgba(99,102,241,0.18);
            color:#e0e7ff;
            font-weight:600;
            transition:all 0.2s ease;
            touch-action:manipulation;
            -webkit-tap-highlight-color:transparent;
        }
        .marketplace-link:hover {
            background:linear-gradient(135deg, var(--accent-soft), var(--accent));
            box-shadow:0 18px 35px rgba(99,102,241,0.22);
        }
        .main-content {
            flex:1;
            padding:40px 48px;
            overflow-y:auto;
            height:100vh;
            display:flex;
            flex-direction:column;
            gap:48px;
            position:relative;
            z-index:1;
        }
        .main-content::-webkit-scrollbar {
            width:8px;
        }
        .main-content::-webkit-scrollbar-thumb {
            background:rgba(148,163,184,0.25);
            border-radius:999px;
        }
        .topbar {
            display:flex;
            justify-content:space-between;
            align-items:flex-start;
            gap:24px;
        }
        .topbar h1 {
            font-size:28px;
            font-weight:700;
            margin-bottom:8px;
        }
        .topbar-subtitle {
            color:var(--muted);
            max-width:520px;
            line-height:1.5;
        }
        .status-chip {
            padding:10px 18px;
            border-radius:999px;
            font-size:12px;
            font-weight:600;
            letter-spacing:0.12em;
            text-transform:uppercase;
            background:rgba(148,163,184,0.12);
            color:var(--muted);
        }
        .status-chip.online {
            background:rgba(16,185,129,0.16);
            color:#34d399;
        }
        .status-chip.offline {
            background:rgba(239,68,68,0.16);
            color:#f87171;
        }
        .section {
            display:flex;
            flex-direction:column;
            gap:20px;
        }
        .section-title {
            font-size:20px;
            font-weight:700;
            letter-spacing:0.02em;
        }
        .grid {
            display:grid;
            gap:24px;
            grid-template-columns:repeat(auto-fit, minmax(320px, 1fr));
        }
        .card {
            background:var(--panel);
            border:1px solid var(--panel-border);
            border-radius:18px;
            padding:24px;
            box-shadow:0 24px 45px rgba(11,17,32,0.45);
        }
        .card h3 {
            font-size:18px;
            font-weight:600;
            margin-bottom:18px;
        }
        .card-header {
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap:16px;
            margin-bottom:22px;
        }
        .card-header h3 {
            margin:0;
        }
        .stat {
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:12px 0;
            border-bottom:1px solid rgba(148,163,184,0.12);
        }
        .stat:last-child {
            border-bottom:none;
        }
        .stat-label {
            color:var(--muted);
            font-weight:500;
        }
        .stat-value {
            font-weight:700;
            color:#f8fafc;
        }
        .badge {
            display:inline-flex;
            align-items:center;
            padding:4px 10px;
            border-radius:999px;
            font-size:12px;
            font-weight:600;
            line-height:1;
        }
        .badge-success {
            background:rgba(16,185,129,0.18);
            color:#34d399;
        }
        .badge-warning {
            background:rgba(250,204,21,0.18);
            color:#facc15;
        }
        .badge-recommended {
            background:rgba(99,102,241,0.2);
            color:#c7d2fe;
        }
        .button-group {
            display:flex;
            flex-wrap:wrap;
            gap:12px;
        }
        .form-group {
            margin-bottom:18px;
        }
        .form-group label {
            display:block;
            margin-bottom:8px;
            font-weight:600;
            color:#cbd5f5;
        }
        .form-control {
            width:100%;
            padding:12px;
            border-radius:12px;
            border:1px solid rgba(148,163,184,0.16);
            background:#0f172a;
            color:var(--text);
            font-size:14px;
        }
        .form-control:focus {
            outline:none;
            border-color:var(--accent-soft);
            box-shadow:0 0 0 3px rgba(99,102,241,0.15);
        }
        .server-list {
            max-height:340px;
            overflow-y:auto;
        }
        .server-item {
            padding:16px;
            border-radius:14px;
            border:1px solid transparent;
            transition:all 0.2s ease;
            margin-bottom:12px;
            background:var(--panel-hover);
        }
        .server-item:hover {
            border-color:var(--accent-soft);
            transform:translateY(-2px);
        }
        .server-name {
            font-weight:600;
            margin-bottom:6px;
        }
        .server-info {
            font-size:13px;
            color:var(--muted);
        }
        .toggle-switch {
            display:flex;
            align-items:center;
            gap:14px;
            padding:12px 0;
            border-bottom:1px solid rgba(148,163,184,0.08);
        }
        .toggle-switch:last-child {
            border-bottom:none;
        }
        .toggle-switch input[type="checkbox"] {
            width:46px;
            height:24px;
            border-radius:999px;
            background:rgba(148,163,184,0.25);
            position:relative;
            appearance:none;
            cursor:pointer;
            transition:background 0.2s ease;
        }
        .toggle-switch input[type="checkbox"]::before {
            content:"";
            position:absolute;
            top:3px;
            left:3px;
            width:18px;
            height:18px;
            background:#ffffff;
            border-radius:50%;
            transition:transform 0.2s ease;
        }
        .toggle-switch input[type="checkbox"]:checked {
            background:rgba(99,102,241,0.8);
        }
        .toggle-switch input[type="checkbox"]:checked::before {
            transform:translateX(20px);
        }
        .toggle-switch label {
            color:var(--text);
            font-weight:500;
        }
        .btn {
            border:none;
            cursor:pointer;
            border-radius:999px;
            padding:12px 20px;
            font-weight:600;
            font-size:14px;
            transition:transform 0.2s ease, box-shadow 0.2s ease;
            touch-action:manipulation;
            -webkit-tap-highlight-color:transparent;
            user-select:none;
        }
        .btn-primary {
            background:linear-gradient(135deg, var(--accent-soft), var(--accent));
            color:#ffffff;
            box-shadow:0 16px 30px rgba(99,102,241,0.25);
        }
        .btn-primary:hover, .btn-primary:active {
            transform:translateY(-1px);
            box-shadow:0 20px 35px rgba(99,102,241,0.35);
        }
        .btn-primary:active {
            transform:translateY(0);
        }
        .btn-secondary {
            background:rgba(148,163,184,0.18);
            color:var(--muted);
            border:1px solid rgba(148,163,184,0.35);
        }
        .btn-secondary:hover, .btn-secondary:active {
            transform:translateY(-1px);
            background:rgba(148,163,184,0.28);
        }
        .btn-secondary:active {
            transform:translateY(0);
            background:rgba(148,163,184,0.35);
        }
        table {
            width:100%;
            border-collapse:collapse;
            font-size:14px;
        }
        th, td {
            padding:14px 12px;
            text-align:left;
            border-bottom:1px solid rgba(148,163,184,0.08);
        }
        th {
            color:var(--muted);
            font-weight:600;
            text-transform:uppercase;
            letter-spacing:0.08em;
            font-size:12px;
        }
        .log-output {
            background:#0f172a;
            border:1px solid rgba(148,163,184,0.12);
            border-radius:14px;
            padding:18px;
            max-height:420px;
            overflow-y:auto;
            font-family:'JetBrains Mono', 'Fira Code', monospace;
            font-size:12px;
            color:#e2e8f0;
        }
        .log-output::-webkit-scrollbar {
            width:6px;
        }
        .log-output::-webkit-scrollbar-thumb {
            background:rgba(148,163,184,0.25);
            border-radius:999px;
        }
        .tool-call {
            border:1px solid rgba(148,163,184,0.12);
            border-radius:16px;
            background:var(--panel-hover);
            margin-bottom:16px;
            overflow:hidden;
        }
        .tool-call summary {
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:12px;
            cursor:pointer;
            padding:14px 16px;
            list-style:none;
            font-weight:600;
            color:var(--text);
        }
        .tool-call summary::-webkit-details-marker {
            display:none;
        }
        .tool-call summary span {
            display:flex;
            align-items:center;
            gap:10px;
        }
        .tool-call-timestamp {
            font-size:12px;
            color:var(--muted);
        }
        .tool-call-body {
            padding:0 16px 16px 16px;
            color:var(--muted);
            font-size:13px;
            line-height:1.55;
        }
        .tool-call-body pre {
            background:#0b152c;
            border-radius:12px;
            padding:14px;
            overflow-x:auto;
            border:1px solid rgba(148,163,184,0.12);
        }
        @media (max-width:1024px) {
            .hamburger {
                display:flex;
            }
            .mobile-overlay {
                display:block;
            }
            body {
                flex-direction:column;
            }
            .sidebar {
                position:fixed;
                top:0;
                left:0;
                width:280px;
                height:100vh;
                z-index:1000;
                transform:translateX(-100%);
                padding:80px 24px 24px 24px;
            }
            .sidebar.active {
                transform:translateX(0);
            }
            .main-content {
                padding:80px 24px 24px 24px;
                height:auto;
                margin-left:0;
            }
            .topbar {
                flex-direction:column;
                gap:16px;
            }
            .topbar h1 {
                font-size:24px;
            }
            .grid {
                grid-template-columns:1fr;
                gap:20px;
            }
            .card-header {
                flex-direction:column;
                align-items:flex-start;
                gap:12px;
            }
            .button-group {
                width:100%;
                justify-content:stretch;
            }
            .button-group > * {
                flex:1;
            }
        }
        @media (max-width:768px) {
            .sidebar {
                width:260px;
                padding:80px 20px 20px 20px;
            }
            .sidebar-brand {
                flex-direction:row;
                gap:12px;
            }
            .brand-icon {
                width:36px;
                height:36px;
                font-size:18px;
            }
            .sidebar-brand-title {
                font-size:16px;
            }
            .sidebar-nav {
                display:flex;
                flex-direction:column;
                gap:8px;
            }
            .nav-link {
                font-size:14px;
                padding:12px 14px;
                width:100%;
            }
            .marketplace-link {
                margin-top:auto;
                width:100%;
            }
            .main-content {
                padding:80px 16px 16px 16px;
            }
            .topbar {
                padding:0;
            }
            .topbar h1 {
                font-size:20px;
            }
            .topbar-subtitle {
                font-size:13px;
            }
            .section {
                padding:24px 0;
            }
            .section-title {
                font-size:16px;
                margin-bottom:16px;
            }
            .stat {
                padding:10px 0;
            }
            .stat-label {
                font-size:11px;
            }
            .stat-value {
                font-size:15px;
            }
            .form-control {
                font-size:14px;
                padding:12px 14px;
            }
            .btn {
                font-size:14px;
                padding:12px 18px;
                min-height:44px;
                display:inline-flex;
                align-items:center;
                justify-content:center;
            }
            .button-group .btn {
                min-width:80px;
            }
            table {
                font-size:12px;
            }
            th, td {
                padding:10px 8px;
            }
            .log-output {
                font-size:11px;
                max-height:300px;
            }
            /* Make form groups stack better on mobile */
            .form-group {
                margin-bottom:16px;
            }
            .form-group label {
                font-size:13px;
            }
            /* Better touch targets */
            .toggle-switch {
                padding:16px 0;
            }
            .toggle-switch input[type="checkbox"] {
                width:52px;
                height:28px;
            }
            .toggle-switch input[type="checkbox"]::before {
                width:22px;
                height:22px;
            }
            .toggle-switch input + label {
                padding:8px 0;
                font-size:14px;
            }
            /* Card headers on mobile */
            .card-header {
                gap:14px;
            }
            .card-header h3 {
                font-size:16px;
            }
            /* Scrollable tables on mobile */
            .card {
                overflow-x:auto;
            }
            /* Better spacing for AI prompt helper on mobile */
            #ai-prompt-helper {
                padding:12px;
            }
            #ai-prompt-helper textarea {
                font-size:13px;
            }
            #ai-prompt-helper .btn {
                padding:14px 20px;
            }
        }
        @media (max-width:480px) {
            .hamburger {
                top:16px;
                left:16px;
                width:40px;
                height:40px;
            }
            .sidebar {
                width:240px;
            }
            .sidebar-brand-subtitle {
                display:none;
            }
            .topbar h1 {
                font-size:18px;
            }
            .grid {
                gap:16px;
            }
            .card {
                padding:16px;
            }
            .card-header h3 {
                font-size:15px;
            }
            .badge {
                font-size:10px;
                padding:4px 8px;
            }
            .status-chip {
                font-size:10px;
                padding:6px 12px;
            }
        }
    </style>
</head>
<body>
<button class="hamburger" id="hamburger" aria-label="Toggle menu">
    <span></span>
    <span></span>
    <span></span>
</button>
<div class="mobile-overlay" id="mobile-overlay"></div>
<div class="app-shell">
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-brand">
            <div class="brand-icon">&#9881;</div>
            <div>
                <div class="sidebar-brand-title">OpenLLM Control Center</div>
                <div class="sidebar-brand-subtitle">dashboard</div>
            </div>
        </div>
        <div class="sidebar-status" id="bot-status">
            <div class="status-dot" id="bot-status-dot"></div>
            <div>
                <div class="status-label">Status</div>
                <div class="status-text" id="bot-status-text">Checking...</div>
            </div>
        </div>
        <nav class="sidebar-nav">
            <a class="nav-link active" href="#overview">Overview</a>
            <a class="nav-link" href="#configuration">Configuration</a>
            <a class="nav-link" href="#tools">Tools</a>
            <a class="nav-link" href="#logging">Logs</a>
            <a class="nav-link" href="#tool-usage">Tool Usage</a>
            <a class="nav-link" href="#provider-management">Providers</a>
            <a class="nav-link" href="#marketplace">Marketplace</a>
        </nav>
        <a class="marketplace-link" href="/marketplace" target="_blank" rel="noopener">Open Marketplace</a>
    </aside>
    <main class="main-content">
        <section class="topbar" id="overview">
            <div>
                <h1>Control your Open Source LLM cluster</h1>
                <p class="topbar-subtitle">
                    Monitor runtime status, tweak server settings, inspect tool usage, and manage integrations - all in a single dark-mode cockpit built for clarity.
                </p>
            </div>
            <div class="status-chip" id="bot-status-chip">initializing</div>
        </section>

        <section class="section" id="snapshot">
            <div class="section-title">Runtime Snapshot</div>
            <div class="grid">
                <div class="card">
                    <div class="card-header">
                        <h3>Bot Health</h3>
                        <span id="bot-uptime" class="badge badge-success">--</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Status</span>
                        <span class="stat-value" id="bot-status-inline">Unknown</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Connected servers</span>
                        <span class="stat-value" id="bot-servers">--</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Default model</span>
                        <span class="stat-value" id="summary-model">--</span>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3>Usage (7 days)</h3>
                        <span class="badge badge-warning">Rolling window</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Total requests</span>
                        <span class="stat-value" id="usage-requests">--</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Total tokens</span>
                        <span class="stat-value" id="usage-tokens">--</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Estimated cost</span>
                        <span class="stat-value" id="usage-cost">--</span>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3>LLM Summary</h3>
                        <span class="badge badge-recommended" id="summary-provider">--</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Provider</span>
                        <span class="stat-value" id="status-provider">--</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Temperature</span>
                        <span class="stat-value" id="status-temperature">--</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Max tokens</span>
                        <span class="stat-value" id="status-max-tokens">--</span>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3>Tool Insights</h3>
                        <span class="badge badge-warning">Live</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Enabled tools</span>
                        <span class="stat-value" id="tool-count">--</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Last tool call</span>
                        <span class="stat-value" id="recent-tool">--</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Last executed</span>
                        <span class="stat-value" id="last-tool">--</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Duration</span>
                        <span class="stat-value" id="last-tool-duration">--</span>
                    </div>
                </div>
            </div>
        </section>

        <section class="section" id="configuration">
            <div class="section-title">Configuration</div>
            <div class="grid">
                <div class="card" id="llm-config-card">
                    <div class="card-header">
                        <h3>LLM Configuration</h3>
                            <div class="button-group">
                            <button class="btn btn-secondary" id="llm-edit-btn" data-tooltip="Edit LLM settings for this server">Edit</button>
                            <button class="btn btn-primary hidden" id="llm-save-btn" data-tooltip="Save LLM configuration">Save</button>
                            <button class="btn btn-secondary hidden" id="llm-cancel-btn" data-tooltip="Cancel editing">Cancel</button>
                        </div>
                    </div>
                    <div id="llm-display">
                        <div class="stat">
                            <span class="stat-label">Provider</span>
                            <span class="stat-value" id="llm-display-provider">--</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Model</span>
                            <span class="stat-value" id="llm-display-model">--</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Temperature</span>
                            <span class="stat-value" id="llm-display-temperature">--</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Max tokens</span>
                            <span class="stat-value" id="llm-display-max">--</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">System Prompt</span>
                            <span class="stat-value" id="llm-display-system-prompt" style="font-size:13px;line-height:1.5;color:var(--muted);">--</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Mention users</span>
                            <span class="stat-value" id="llm-display-mention-users" style="font-size:13px;line-height:1.5;color:var(--muted);">--</span>
                        </div>
                    </div>
                    <form id="llm-form" class="hidden">
                        <div class="form-group">
                            <label for="llm-provider-select">Provider</label>
                            <select id="llm-provider-select" class="form-control"></select>
                        </div>
                        <div class="form-group">
                            <label for="llm-model-input">Model</label>
                            <input id="llm-model-input" class="form-control" list="llm-model-options" placeholder="gpt-4o-mini" />
                            <datalist id="llm-model-options"></datalist>
                        </div>
                        <div class="form-group">
                            <label for="llm-temperature-input">Temperature</label>
                            <input id="llm-temperature-input" class="form-control" type="number" step="0.1" min="0" max="2" />
                        </div>
                        <div class="form-group">
                            <label for="llm-max-input">Max tokens</label>
                            <input id="llm-max-input" class="form-control" placeholder="4096" />
                        </div>
                        <div class="form-group">
                            <label for="llm-system-prompt-input">
                                System Prompt <span style="color:var(--muted);font-size:12px;">(personality & instructions)</span>
                            </label>
                                <div style="display:flex;gap:8px;margin-bottom:8px;">
                                <button type="button" class="btn btn-secondary" id="ai-enhance-prompt-btn" data-tooltip="Use AI to rewrite or enhance your system prompt" style="flex:0 0 auto;">âœ¨ Enhance with AI</button>
                                <button type="button" class="btn btn-secondary hidden" id="ai-cancel-btn" data-tooltip="Close AI prompt helper" style="flex:0 0 auto;">Cancel</button>
                            </div>
                            <textarea id="llm-system-prompt-input" class="form-control" rows="4" placeholder="You are a helpful AI assistant..."></textarea>
                            <div id="ai-prompt-helper" class="hidden" style="margin-top:12px;padding:16px;background:rgba(99,102,241,0.1);border:1px solid rgba(99,102,241,0.3);border-radius:12px;">
                                <label style="display:block;margin-bottom:8px;font-size:13px;font-weight:600;">Describe how you want to modify the prompt:</label>
                                <textarea id="ai-instruction-input" class="form-control" rows="2" placeholder="e.g., Make it more professional, Add humor, Make it respond in pirate speak..." style="margin-bottom:8px;"></textarea>
                                <button type="button" class="btn btn-primary" id="ai-generate-btn" data-tooltip="Generate an improved system prompt using the current LLM" style="width:100%;">Generate Enhanced Prompt</button>
                                <div id="ai-loading" class="hidden" style="margin-top:12px;text-align:center;color:var(--muted);font-size:13px;">
                                    <span>ðŸ¤– AI is working on your prompt...</span>
                                </div>
                            </div>
                        </div>
                        <div class="toggle-switch" data-tooltip="If enabled, responses will be kept under 2000 characters">
                            <input type="checkbox" id="enforce-char-limit-toggle">
                            <label for="enforce-char-limit-toggle">Enforce 2000 character limit</label>
                        </div>
                        <div class="toggle-switch" data-tooltip="When enabled, the bot will ping the user in its reply">
                            <input type="checkbox" id="mention-users-toggle">
                            <label for="mention-users-toggle">Mention (ping) users in bot responses</label>
                        </div>
                        <div class="form-group" style="margin-top:12px;">
                            <label style="font-weight:600;display:block;margin-bottom:6px;">Save target</label>
                            <div style="display:flex;gap:12px;align-items:center;">
                                <label style="display:flex;align-items:center;gap:8px;" data-tooltip="Also save these changes to the global config.yaml (defaults)">
                                    <input type="checkbox" id="llm-save-global">
                                    <span style="font-size:13px;color:var(--muted);">Also update global defaults (config.yaml)</span>
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3>Server Connections</h3>
                        <button class="btn btn-secondary" id="refresh-servers" data-tooltip="Reload connected servers list">Refresh</button>
                    </div>
                    <div class="server-list" id="server-list">Loading server data...</div>
                </div>
            </div>
        </section>

        <section class="section" id="tools">
            <div class="section-title">Tools</div>
            <div class="grid">
                <div class="card">
                    <div class="card-header">
                        <h3>Enabled Tools</h3>
                        <button class="btn btn-secondary" id="refresh-tools" data-tooltip="Reload available tools">Refresh</button>
                    </div>
                    <div id="tools-list" class="loading">Retrieving tool information...</div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3>Plugin Status</h3>
                        <button class="btn btn-secondary" id="refresh-plugins" data-tooltip="Reload installed plugins">Refresh</button>
                    </div>
                    <div id="plugins-list" class="loading">Loading installed plugins...</div>
                </div>
            </div>
        </section>

        <section class="section" id="logging">
            <div class="section-title">Logging</div>
            <div class="card">
                <div class="card-header">
                    <h3>Live Console</h3>
                    <div class="button-group">
                        <button class="btn btn-secondary" id="refresh-logs" data-tooltip="Reload log output">Refresh</button>
                        <a class="btn btn-secondary" href="/api/logs" target="_blank" rel="noopener" data-tooltip="Download full logs">Download</a>
                    </div>
                </div>
                <div id="log-output" class="log-output">Awaiting log stream...</div>
            </div>
        </section>

        <section class="section" id="tool-usage">
            <div class="section-title">Tool Usage</div>
            <div class="card">
                <div class="card-header">
                    <h3>Recent Tool Calls</h3>
                    <button class="btn btn-secondary" id="refresh-tool-calls" data-tooltip="Reload recent tool call history">Refresh</button>
                </div>
                <div id="tool-calls" class="loading">Fetching recent tool calls...</div>
            </div>
        </section>

        <section class="section" id="provider-management">
            <div class="section-title">Provider Management</div>
            <div class="grid">
                <div class="card" id="provider-config-card">
                    <div class="card-header">
                        <h3>Configure Providers</h3>
                        <button class="btn btn-secondary" id="provider-refresh-btn">Refresh</button>
                    </div>
                    <div id="provider-config-list">
                        <!-- Provider configuration forms will be loaded here -->
                    </div>
                </div>
            </div>
        </section>

        <section class="section" id="marketplace">
            <div class="section-title">Providers & Marketplace</div>
            <div class="grid">
                <div class="card">
                    <div class="card-header">
                        <h3>Provider Availability</h3>
                        <button class="btn btn-secondary" id="refresh-providers">Refresh</button>
                    </div>
                    <div id="providers-list" class="loading">Loading providers...</div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3>Marketplace Insights</h3>
                        <a class="btn btn-primary" href="/marketplace" target="_blank" rel="noopener">View Marketplace</a>
                    </div>
                    <div id="marketplace-summary" class="loading">Marketplace data will appear here once providers are loaded.</div>
                </div>
            </div>
        </section>
    </main>
</div>
<script>
    const state = {
        currentConfig: {},
        currentServerId: null,
    availableProviders: [],
        plugins: [],
        tools: [],
    toolState: {},
    pluginsLoaded: false
    };

    function setStatusUI(data) {
        const online = !!data.online;
        document.getElementById('bot-status-text').textContent = online ? 'Online' : 'Offline';
        document.getElementById('bot-status-inline').textContent = online ? 'Online' : 'Offline';
        document.getElementById('bot-status-chip').textContent = online ? 'ONLINE' : 'OFFLINE';
        document.getElementById('bot-status-chip').classList.toggle('online', online);
        document.getElementById('bot-status-chip').classList.toggle('offline', !online);
        document.getElementById('bot-status-dot').classList.toggle('online', online);
        document.getElementById('bot-uptime').textContent = data.uptime || '--';
        document.getElementById('bot-servers').textContent = data.servers != null ? data.servers : '--';
    }

    function updateLlmSummary(config) {
        const provider = config.llm_provider || config.llm?.default_provider || 'N/A';
        const model = config.llm_model || config.llm?.default_model || 'N/A';
        const temperature = config.temperature ?? config.llm?.temperature ?? 'N/A';
        const maxTokens = config.max_tokens ?? config.llm?.max_tokens ?? 'N/A';
        const systemPrompt = config.system_prompt || config.llm?.system_prompt || 'Not set';

        document.getElementById('llm-display-provider').textContent = provider;
        document.getElementById('llm-display-model').textContent = model;
        document.getElementById('llm-display-temperature').textContent = temperature;
        document.getElementById('llm-display-max').textContent = maxTokens;
        document.getElementById('llm-display-system-prompt').textContent = systemPrompt.length > 150 ? systemPrompt.substring(0, 150) + '...' : systemPrompt;

        const mentionUsers = config.mention_users ?? config.llm?.mention_users ?? false;

        document.getElementById('status-provider').textContent = provider;
        document.getElementById('summary-provider').textContent = provider;
        document.getElementById('summary-model').textContent = model;
        document.getElementById('status-temperature').textContent = temperature;
        document.getElementById('status-max-tokens').textContent = maxTokens;
        document.getElementById('llm-display-mention-users').textContent = mentionUsers ? 'Yes' : 'No';
    }

    function enterLlmEdit() {
        document.getElementById('llm-display').classList.add('hidden');
        document.getElementById('llm-form').classList.remove('hidden');
        document.getElementById('llm-edit-btn').classList.add('hidden');
        document.getElementById('llm-save-btn').classList.remove('hidden');
        document.getElementById('llm-cancel-btn').classList.remove('hidden');

        if (!state.availableProviders.length) {
            loadProviders();
        } else {
            populateProviderSelect();
        }

        const providerSelect = document.getElementById('llm-provider-select');
        const currentProvider = state.currentConfig.llm_provider || state.currentConfig.llm?.default_provider || '';
        providerSelect.value = currentProvider;
        updateModelOptions(currentProvider);

        document.getElementById('llm-model-input').value = state.currentConfig.llm_model || state.currentConfig.llm?.default_model || '';
        document.getElementById('llm-temperature-input').value = state.currentConfig.temperature ?? state.currentConfig.llm?.temperature ?? 0.7;
        document.getElementById('llm-max-input').value = state.currentConfig.max_tokens ?? state.currentConfig.llm?.max_tokens ?? 4096;
        document.getElementById('llm-system-prompt-input').value = state.currentConfig.system_prompt || state.currentConfig.llm?.system_prompt || '';
        document.getElementById('enforce-char-limit-toggle').checked = state.currentConfig.enforce_char_limit ?? false;
        document.getElementById('mention-users-toggle').checked = state.currentConfig.mention_users ?? state.currentConfig.llm?.mention_users ?? false;
    }

    function exitLlmEdit() {
        document.getElementById('llm-display').classList.remove('hidden');
        document.getElementById('llm-form').classList.add('hidden');
        document.getElementById('llm-edit-btn').classList.remove('hidden');
        document.getElementById('llm-save-btn').classList.add('hidden');
        document.getElementById('llm-cancel-btn').classList.add('hidden');
    }

    function populateProviderSelect() {
        const select = document.getElementById('llm-provider-select');
        select.innerHTML = '';
        state.availableProviders.forEach(provider => {
            const option = document.createElement('option');
            option.value = provider.name;
            option.textContent = provider.display_name || provider.name;
            option.disabled = !provider.available;
            select.appendChild(option);
        });
    }

    function updateModelOptions(providerName) {
        const dataList = document.getElementById('llm-model-options');
        dataList.innerHTML = '';
        const provider = state.availableProviders.find(p => p.name === providerName);
        if (provider && Array.isArray(provider.models)) {
            provider.models.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                dataList.appendChild(option);
            });
        }
    }

    async function loadStatus() {
        try {
            const response = await fetch('/api/status');
            if (!response.ok) return;
            const data = await response.json();
            setStatusUI(data);
        } catch (error) {
            console.error('Status fetch failed:', error);
        }
    }

    async function loadServers() {
        try {
            const response = await fetch('/api/servers');
            if (!response.ok) throw new Error('Failed to fetch servers');
            const servers = await response.json();

            const list = document.getElementById('server-list');
            if (!servers.length) {
                list.textContent = 'No servers connected.';
                state.currentServerId = null;
            } else {
                state.currentServerId = servers[0].id;
                list.innerHTML = servers.map(server => `
                    <div class="server-item">
                        <div class="server-name">${server.name}</div>
                        <div class="server-info">${server.member_count} members - ${server.llm_provider || 'N/A'} (${server.llm_model || 'N/A'})</div>
                    </div>
                `).join('');
            }

            await loadConfig();
        } catch (error) {
            console.error('Server fetch failed:', error);
            document.getElementById('server-list').textContent = 'Unable to load server data.';
        }
    }

    async function loadConfig() {
        try {
            let config;
            if (state.currentServerId) {
                const res = await fetch(`/api/servers/${state.currentServerId}/config`);
                if (!res.ok) throw new Error('Server config request failed');
                config = await res.json();
            } else {
                const res = await fetch('/api/config');
                if (!res.ok) throw new Error('Config request failed');
                config = await res.json();
            }
            state.currentConfig = config || {};
            updateLlmSummary(state.currentConfig);
        } catch (error) {
            console.error('Config fetch failed:', error);
        }
    }

    async function saveLlmConfig() {
        if (!state.currentServerId) {
            console.error('Cannot save config without a server');
            return;
        }
        try {
            const payload = {
                llm_provider: document.getElementById('llm-provider-select').value,
                llm_model: document.getElementById('llm-model-input').value,
                temperature: parseFloat(document.getElementById('llm-temperature-input').value),
                max_tokens: document.getElementById('llm-max-input').value.trim().toLowerCase() === 'auto'
                    ? 'auto'
                    : parseInt(document.getElementById('llm-max-input').value, 10),
                system_prompt: document.getElementById('llm-system-prompt-input').value,
                enforce_char_limit: document.getElementById('enforce-char-limit-toggle').checked ? 1 : 0,
                mention_users: document.getElementById('mention-users-toggle').checked ? 1 : 0
            };

            const response = await fetch(`/api/servers/${state.currentServerId}/config`, {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify(payload)
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error || 'Failed to save configuration');
            }

            // If requested, also update global defaults in config.yaml
            const saveGlobal = document.getElementById('llm-save-global')?.checked;
            if (saveGlobal) {
                try {
                    const globalPayload = {};
                    if (payload.llm_provider) globalPayload['llm.default_provider'] = payload.llm_provider;
                    if (payload.llm_model) globalPayload['llm.default_model'] = payload.llm_model;
                    if (payload.temperature !== undefined) globalPayload['llm.temperature'] = payload.temperature;
                    if (payload.max_tokens !== undefined) globalPayload['llm.max_tokens'] = payload.max_tokens;
                    if (payload.system_prompt !== undefined) globalPayload['llm.system_prompt'] = payload.system_prompt;

                    const gResp = await fetch('/api/config', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(globalPayload)
                    });

                    if (!gResp.ok) {
                        const ge = await gResp.json();
                        console.warn('Failed to update global config:', ge);
                    }
                } catch (e) {
                    console.error('Global config update failed:', e);
                }
            }

            await loadConfig();
            exitLlmEdit();
        } catch (error) {
            console.error('Save config failed:', error);
            alert('Failed to save configuration: ' + error.message);
        }
    }

    async function loadProviders() {
        try {
            const response = await fetch('/api/providers');
            if (!response.ok) throw new Error('Provider request failed');
            state.availableProviders = await response.json();
            populateProviderSelect();
            renderProviderList();
            renderProviderConfig();
            renderMarketplaceSummary();
        } catch (error) {
            console.error('Provider fetch failed:', error);
            document.getElementById('providers-list').textContent = 'Unable to load provider data.';
        }
    }

    async function loadUsage() {
        try {
            const response = await fetch('/api/usage/stats?days=7');
            if (!response.ok) throw new Error('Usage request failed');
            const data = await response.json();
            document.getElementById('usage-requests').textContent = data.total.requests.toLocaleString();
            document.getElementById('usage-tokens').textContent = data.total.tokens.toLocaleString();
            document.getElementById('usage-cost').textContent = '$' + data.total.cost.toFixed(4);
        } catch (error) {
            console.error('Usage fetch failed:', error);
        }
    }

    function renderPluginList() {
        const container = document.getElementById('plugins-list');
        if (!container || !state.pluginsLoaded) return;
        if (!state.plugins.length) {
            container.textContent = 'No plugins installed yet.';
            return;
        }

        container.innerHTML = state.plugins.map(plugin => {
            const rawName = plugin.name || '';
            const keyVariants = [
                rawName,
                rawName.toLowerCase(),
                rawName.replace(/\s+/g, '_').toLowerCase()
            ].filter(Boolean);

            let resolved = plugin.enabled;
            keyVariants.some(key => {
                if (key && key in state.toolState) {
                    resolved = state.toolState[key];
                    return true;
                }
                return false;
            });

            return `
                <div class="stat">
                    <span class="stat-label">${plugin.name} v${plugin.version}</span>
                    <span class="badge ${resolved ? 'badge-success' : 'badge-warning'}">${resolved ? 'Enabled' : 'Disabled'}</span>
                </div>
            `;
        }).join('');
    }

    async function loadPlugins() {
        try {
            const response = await fetch('/api/plugins');
            if (!response.ok) throw new Error('Plugin request failed');
            state.plugins = await response.json();
            state.pluginsLoaded = true;
            renderPluginList();
        } catch (error) {
            console.error('Plugin fetch failed:', error);
            const container = document.getElementById('plugins-list');
            if (container) container.textContent = 'Unable to load plugin data.';
        }
    }

    async function loadTools() {
        try {
            const response = await fetch('/api/tools/available');
            const payload = await response.json();
            if (!payload.success) throw new Error(payload.error || 'Tool request failed');
            const tools = payload.tools || [];
            state.tools = tools;
            state.toolState = {};

            tools.forEach(tool => {
                const baseName = tool.name || '';
                const variants = new Set([
                    baseName,
                    baseName.toLowerCase(),
                    baseName.replace(/\s+/g, '_').toLowerCase()
                ]);
                if (tool.plugin?.name) {
                    const pluginRaw = tool.plugin.name;
                    variants.add(pluginRaw.toLowerCase());
                    variants.add(pluginRaw.replace(/\s+/g, '_').toLowerCase());
                }
                variants.forEach(key => {
                    if (key) state.toolState[key] = tool.enabled;
                });
            });

            const container = document.getElementById('tools-list');
            if (!tools.length) {
                container.textContent = 'No tools available.';
            } else {
                container.innerHTML = tools.map(tool => `
                    <div class="toggle-switch">
                        <input type="checkbox" id="tool-${tool.name}" ${tool.enabled ? 'checked' : ''} onchange="toggleTool('${tool.name}', this.checked)">
                        <label for="tool-${tool.name}">
                            ${tool.plugin ? tool.plugin.icon + ' ' : ''}${tool.name}
                        </label>
                    </div>
                `).join('');
            }
            document.getElementById('tool-count').textContent = tools.filter(t => t.enabled).length;
        } catch (error) {
            console.error('Tool fetch failed:', error);
            document.getElementById('tools-list').textContent = 'Unable to load tool data.';
            document.getElementById('tool-count').textContent = '--';
        }
    renderPluginList();
    }

    async function loadToolCalls() {
        try {
            const response = await fetch('/api/tool_calls?limit=20');
            if (!response.ok) throw new Error('Tool call request failed');
            const toolCalls = await response.json();
            const container = document.getElementById('tool-calls');
            if (!toolCalls.length) {
                container.textContent = 'No tool calls recorded yet.';
                document.getElementById('recent-tool').textContent = '--';
                document.getElementById('last-tool').textContent = '--';
                document.getElementById('last-tool-duration').textContent = '--';
                return;
            }
            container.innerHTML = toolCalls.map(call => `
                <details class="tool-call">
                    <summary>
                        <span>
                            <span class="badge ${call.success ? 'badge-success' : 'badge-warning'}">${call.tool_name}</span>
                            ${call.success ? 'Success' : 'Error'}
                        </span>
                        <span class="tool-call-timestamp">${new Date(call.timestamp).toLocaleString()}</span>
                    </summary>
                    <div class="tool-call-body">
                        <strong>Arguments</strong>
                        <pre>${JSON.stringify(call.parameters, null, 2)}</pre>
                        <strong>Result</strong>
                        <pre>${call.result || 'No result'}</pre>
                        ${call.error_message ? `<strong>Error</strong><pre>${call.error_message}</pre>` : ''}
                        <div style="font-size:12px;margin-top:10px;">Server: ${call.server_id || 'N/A'} - User: ${call.user_id || 'N/A'}</div>
                    </div>
                </details>
            `).join('');

            const latest = toolCalls[0];
            document.getElementById('recent-tool').textContent = latest.tool_name || 'Unknown';
            document.getElementById('last-tool').textContent = latest.timestamp ? new Date(latest.timestamp).toLocaleTimeString() : '--';
            document.getElementById('last-tool-duration').textContent = latest.duration || '--';
        } catch (error) {
            console.error('Tool call fetch failed:', error);
            document.getElementById('tool-calls').textContent = 'Unable to load tool call history.';
        }
    }

    async function loadLogs() {
        try {
            const response = await fetch('/api/logs');
            if (!response.ok) throw new Error('Log request failed');
            const data = await response.json();
            const lines = (data.logs || []).slice(-200);
            document.getElementById('log-output').innerHTML = lines.length
                ? lines.map(line => `<div>${line}</div>`).join('')
                : '<div style="color:#64748b;">No logs yet.</div>';
            const logEl = document.getElementById('log-output');
            logEl.scrollTop = logEl.scrollHeight;
        } catch (error) {
            console.error('Log fetch failed:', error);
            document.getElementById('log-output').textContent = 'Unable to load logs.';
        }
    }

    function renderProviderList() {
        const container = document.getElementById('providers-list');
        if (!state.availableProviders.length) {
            container.textContent = 'No providers detected.';
            return;
        }
        container.innerHTML = state.availableProviders.map(provider => `
            <div class="stat">
                <span class="stat-label">${provider.display_name || provider.name}</span>
                <span>
                    ${provider.recommended ? '<span class="badge badge-recommended">Recommended</span>' : ''}
                    <span class="badge ${provider.available ? 'badge-success' : 'badge-warning'}">${provider.available ? 'Available' : 'Not configured'}</span>
                </span>
            </div>
        `).join('');
    }

    function renderMarketplaceSummary() {
        const summary = document.getElementById('marketplace-summary');
        if (!state.availableProviders.length) {
            summary.textContent = 'Marketplace data will appear here once providers are loaded.';
            return;
        }
        const readyProviders = state.availableProviders.filter(p => p.available);
        summary.innerHTML = `
            <div class="stat">
                <span class="stat-label">Providers configured</span>
                <span class="stat-value">${readyProviders.length}/${state.availableProviders.length}</span>
            </div>
            <div class="stat">
                <span class="stat-label">Recommended provider</span>
                <span class="stat-value">${(state.availableProviders.find(p => p.recommended) || {}).display_name || 'N/A'}</span>
            </div>
            <div class="stat">
                <span class="stat-label">Last sync</span>
                <span class="stat-value">${new Date().toLocaleTimeString()}</span>
            </div>
        `;
    }

    function renderProviderConfig() {
        const container = document.getElementById('provider-config-list');
        if (!state.availableProviders.length) {
            container.textContent = 'Loading provider data...';
            return;
        }
        
        container.innerHTML = state.availableProviders.map(provider => {
            const configured = provider.configured || false;
            const envVar = provider.env_var || 'N/A';
            const providerId = `provider-${provider.name}`;
            
            return `
                <div class="stat" style="flex-direction:column;align-items:stretch;padding:16px 0;border-bottom:1px solid rgba(148,163,184,0.08);">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;cursor:pointer;" onclick="toggleProviderConfig('${provider.name}')" data-tooltip="Tap to expand provider configuration">
                        <div style="flex:1;">
                            <span class="stat-label" style="font-size:16px;font-weight:600;color:var(--text);">${provider.display_name || provider.name}</span>
                            ${provider.recommended ? '<span class="badge badge-recommended" style="margin-left:8px;">Recommended</span>' : ''}
                            <span class="badge ${configured ? 'badge-success' : 'badge-warning'}" style="margin-left:8px;">${configured ? 'Configured' : 'Not configured'}</span>
                        </div>
                        <span id="${providerId}-arrow" style="font-size:20px;color:var(--muted);transition:transform 0.3s ease;">â–¼</span>
                    </div>
                    <div id="${providerId}-config" class="provider-config-form hidden" style="margin-top:8px;">
                        <div style="font-size:12px;color:var(--muted);margin-bottom:8px;">
                            ${provider.name === 'lmstudio' ? 'LM Studio local server (no API key required)' : 
                              provider.name === 'custom' ? 'Custom OpenAI-compatible endpoint' :
                              provider.name === 'ollama' ? 'Ollama local server (no API key required)' :
                              `Environment variable: ${envVar}`}
                        </div>
                        ${provider.name === 'lmstudio' || provider.name === 'ollama' ? `
                            <div style="margin-top:8px;">
                    <input type="text" 
                        id="provider-endpoint-${provider.name}" 
                        class="form-control" 
                        placeholder="${provider.name === 'lmstudio' ? 'http://localhost:1234/v1' : 'http://localhost:11434'}" 
                        value="${configured ? (provider.endpoint || '') : ''}"
                        style="margin-bottom:8px;" data-tooltip="Custom endpoint for ${provider.display_name || provider.name}">
                    <button class="btn btn-primary btn-sm" onclick="saveProviderEndpoint('${provider.name}')" data-tooltip="Save endpoint for ${provider.display_name || provider.name}">Save Endpoint</button>
                            </div>
                        ` : provider.name === 'custom' ? `
                            <div style="margin-top:8px;">
                    <input type="text" 
                        id="provider-endpoint-${provider.name}" 
                        class="form-control" 
                        placeholder="https://api.example.com/v1" 
                        value="${configured ? (provider.endpoint || '') : ''}"
                        style="margin-bottom:8px;" data-tooltip="Custom OpenAI-compatible base URL">
                    <input type="password" 
                        id="provider-key-${provider.name}" 
                        class="form-control" 
                        placeholder="API Key (optional)" 
                        style="margin-bottom:8px;" data-tooltip="Optional API key for the custom endpoint">
                    <button class="btn btn-primary btn-sm" onclick="saveCustomProvider()" data-tooltip="Save custom provider settings">Save Custom Provider</button>
                            </div>
                        ` : `
                            <div style="margin-top:8px;">
                                <input type="password" 
                                       id="provider-key-${provider.name}" 
                                       class="form-control" 
                                       placeholder="${configured ? 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' : 'Enter API key'}" 
                                       style="margin-bottom:8px;" data-tooltip="API key for ${provider.display_name || provider.name}">
                                <div style="display:flex;gap:8px;">
                                    <button class="btn btn-primary btn-sm" onclick="saveProviderKey('${provider.name}', '${envVar}')" data-tooltip="Save API key for ${provider.display_name || provider.name}">Save API Key</button>
                                    ${configured ? `<button class="btn btn-secondary btn-sm" onclick="clearProviderKey('${provider.name}', '${envVar}')" data-tooltip="Clear stored API key">Clear</button>` : ''}
                                </div>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }).join('');
    }

    window.toggleProviderConfig = function(providerName) {
        const providerId = `provider-${providerName}`;
        const configDiv = document.getElementById(`${providerId}-config`);
        const arrow = document.getElementById(`${providerId}-arrow`);
        
        if (configDiv && arrow) {
            configDiv.classList.toggle('hidden');
            arrow.style.transform = configDiv.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
        }
    };

    window.saveProviderKey = async function(providerName, envVar) {
        const input = document.getElementById(`provider-key-${providerName}`);
        const apiKey = input.value.trim();
        
        if (!apiKey) {
            alert('Please enter an API key');
            return;
        }
        
        try {
            const response = await fetch('/api/providers/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    provider: providerName,
                    env_var: envVar,
                    api_key: apiKey
                })
            });
            
            const result = await response.json();
            if (result.success) {
                alert('API key saved successfully! Restart the bot for changes to take effect.');
                input.value = '';
                await loadProviders();
            } else {
                throw new Error(result.error || 'Failed to save API key');
            }
        } catch (error) {
            console.error('Save provider key failed:', error);
            alert('Failed to save API key: ' + error.message);
        }
    };

    window.clearProviderKey = async function(providerName, envVar) {
        if (!confirm('Are you sure you want to clear this API key?')) {
            return;
        }
        
        try {
            const response = await fetch('/api/providers/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    provider: providerName,
                    env_var: envVar,
                    api_key: ''
                })
            });
            
            const result = await response.json();
            if (result.success) {
                alert('API key cleared successfully! Restart the bot for changes to take effect.');
                await loadProviders();
            } else {
                throw new Error(result.error || 'Failed to clear API key');
            }
        } catch (error) {
            console.error('Clear provider key failed:', error);
            alert('Failed to clear API key: ' + error.message);
        }
    };

    window.saveProviderEndpoint = async function(providerName) {
        const input = document.getElementById(`provider-endpoint-${providerName}`);
        const endpoint = input.value.trim();
        
        if (!endpoint) {
            alert('Please enter an endpoint URL');
            return;
        }
        
        try {
            const response = await fetch('/api/providers/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    provider: providerName,
                    endpoint: endpoint
                })
            });
            
            const result = await response.json();
            if (result.success) {
                alert('Endpoint saved successfully! Restart the bot for changes to take effect.');
                await loadProviders();
            } else {
                throw new Error(result.error || 'Failed to save endpoint');
            }
        } catch (error) {
            console.error('Save endpoint failed:', error);
            alert('Failed to save endpoint: ' + error.message);
        }
    };

    window.saveCustomProvider = async function() {
        const endpointInput = document.getElementById('provider-endpoint-custom');
        const keyInput = document.getElementById('provider-key-custom');
        
        const endpoint = endpointInput.value.trim();
        const apiKey = keyInput.value.trim();
        
        if (!endpoint) {
            alert('Please enter an endpoint URL');
            return;
        }
        
        try {
            const response = await fetch('/api/providers/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    provider: 'custom',
                    endpoint: endpoint,
                    api_key: apiKey || ''
                })
            });
            
            const result = await response.json();
            if (result.success) {
                alert('Custom provider configured successfully! Restart the bot for changes to take effect.');
                endpointInput.value = '';
                keyInput.value = '';
                await loadProviders();
            } else {
                throw new Error(result.error || 'Failed to save custom provider');
            }
        } catch (error) {
            console.error('Save custom provider failed:', error);
            alert('Failed to save custom provider: ' + error.message);
        }
    };

    window.toggleTool = async function(toolName, enabled) {
        try {
            const response = await fetch(`/api/tools/toggle/${toolName}`, {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({enabled})
            });
            const result = await response.json();
            if (!result.success) {
                document.getElementById(`tool-${toolName}`).checked = !enabled;
                throw new Error(result.error || 'Toggle failed');
            }
            await loadTools();
        } catch (error) {
            console.error('Toggle tool failed:', error);
            alert('Unable to update tool state.');
            document.getElementById(`tool-${toolName}`).checked = !enabled;
        }
    };

    function handleNavHighlight() {
        const links = document.querySelectorAll('.nav-link');
        const scrollPos = window.scrollY;
        links.forEach(link => {
            const target = document.querySelector(link.getAttribute('href'));
            if (!target) return;
            const top = target.offsetTop - 140;
            const bottom = top + target.offsetHeight;
            if (scrollPos >= top && scrollPos < bottom) {
                link.classList.add('active');
            } else {
                link.classList.remove('active');
            }
        });
    }

    function showAiPromptHelper() {
        document.getElementById('ai-prompt-helper').classList.remove('hidden');
        document.getElementById('ai-enhance-prompt-btn').classList.add('hidden');
        document.getElementById('ai-cancel-btn').classList.remove('hidden');
    }

    function hideAiPromptHelper() {
        document.getElementById('ai-prompt-helper').classList.add('hidden');
        document.getElementById('ai-enhance-prompt-btn').classList.remove('hidden');
        document.getElementById('ai-cancel-btn').classList.add('hidden');
        document.getElementById('ai-loading').classList.add('hidden');
    }

    async function generateEnhancedPrompt() {
        const currentPrompt = document.getElementById('llm-system-prompt-input').value;
        const instruction = document.getElementById('ai-instruction-input').value.trim();
        
        if (!instruction) {
            alert('Please describe how you want to modify the prompt');
            return;
        }

        try {
            document.getElementById('ai-loading').classList.remove('hidden');
            document.getElementById('ai-generate-btn').disabled = true;

            const metaPrompt = currentPrompt 
                ? `Current system prompt:\n${currentPrompt}\n\nUser request: ${instruction}\n\nPlease rewrite the system prompt according to the user's request. Return only the new system prompt, nothing else.`
                : `Create a system prompt for a Discord bot with the following characteristics: ${instruction}\n\nReturn only the system prompt, nothing else.`;

            // Use the current server's LLM config
            const response = await fetch('/api/config/llm/generate-prompt', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    prompt: metaPrompt,
                    server_id: state.currentServerId
                })
            });

            if (!response.ok) {
                throw new Error('Failed to generate prompt');
            }

            const data = await response.json();
            if (data.success && data.prompt) {
                document.getElementById('llm-system-prompt-input').value = data.prompt;
                document.getElementById('ai-instruction-input').value = '';
                hideAiPromptHelper();
            } else {
                throw new Error(data.error || 'No prompt returned');
            }
        } catch (error) {
            console.error('AI prompt generation failed:', error);
            alert('Failed to generate enhanced prompt: ' + error.message);
        } finally {
            document.getElementById('ai-loading').classList.add('hidden');
            document.getElementById('ai-generate-btn').disabled = false;
        }
    }

    function toggleMobileMenu() {
        const hamburger = document.getElementById('hamburger');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('mobile-overlay');
        
        hamburger.classList.toggle('active');
        sidebar.classList.toggle('active');
        overlay.classList.toggle('active');
        
        // Prevent body scroll when menu is open
        document.body.style.overflow = sidebar.classList.contains('active') ? 'hidden' : '';
    }

    function closeMobileMenu() {
        const hamburger = document.getElementById('hamburger');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('mobile-overlay');
        
        hamburger.classList.remove('active');
        sidebar.classList.remove('active');
        overlay.classList.remove('active');
        document.body.style.overflow = '';
    }

    function bindEvents() {
        // Mobile menu
        const hamburger = document.getElementById('hamburger');
        const overlay = document.getElementById('mobile-overlay');
        
        if (hamburger) {
            hamburger.addEventListener('click', toggleMobileMenu);
            hamburger.addEventListener('touchstart', (e) => {
                e.preventDefault();
                toggleMobileMenu();
            }, { passive: false });
        }
        
        if (overlay) {
            overlay.addEventListener('click', closeMobileMenu);
        }

        // Tooltip touch handling: toggle tooltip-visible class on touch for elements with data-tooltip
        document.querySelectorAll('[data-tooltip]').forEach(el => {
            // Show tooltip on touchstart (mobile)
            el.addEventListener('touchstart', (e) => {
                // Allow clicks to still go through for buttons that rely on click handlers
                e.stopPropagation();
                // Toggle visibility
                if (el.classList.contains('tooltip-visible')) {
                    el.classList.remove('tooltip-visible');
                } else {
                    // Hide others
                    document.querySelectorAll('[data-tooltip].tooltip-visible').forEach(x => x.classList.remove('tooltip-visible'));
                    el.classList.add('tooltip-visible');
                    // Auto-hide after 3 seconds
                    setTimeout(() => el.classList.remove('tooltip-visible'), 3000);
                }
            }, { passive: true });

            // Keyboard focus support
            el.addEventListener('focus', () => el.classList.add('tooltip-visible'));
            el.addEventListener('blur', () => el.classList.remove('tooltip-visible'));
        });
        
        // Close mobile menu when clicking a nav link
        document.querySelectorAll('.nav-link, .marketplace-link').forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth <= 1024) {
                    closeMobileMenu();
                }
            });
        });
        
        // Add click and touch listeners to all buttons
        const addButtonListener = (id, handler) => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('click', handler);
                element.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    handler(e);
                }, { passive: false });
            }
        };
        
        addButtonListener('llm-edit-btn', enterLlmEdit);
        addButtonListener('llm-cancel-btn', () => {
            exitLlmEdit();
            updateLlmSummary(state.currentConfig);
        });
        addButtonListener('llm-save-btn', saveLlmConfig);
        addButtonListener('ai-enhance-prompt-btn', showAiPromptHelper);
        addButtonListener('ai-cancel-btn', hideAiPromptHelper);
        addButtonListener('ai-generate-btn', generateEnhancedPrompt);
        addButtonListener('refresh-servers', loadServers);
        addButtonListener('refresh-tools', loadTools);
        addButtonListener('refresh-plugins', loadPlugins);
        addButtonListener('refresh-logs', loadLogs);
        addButtonListener('refresh-tool-calls', loadToolCalls);
        addButtonListener('refresh-providers', loadProviders);
        addButtonListener('provider-refresh-btn', loadProviders);
        
        const providerSelect = document.getElementById('llm-provider-select');
        if (providerSelect) {
            providerSelect.addEventListener('change', event => {
                updateModelOptions(event.target.value);
            });
        }
        
        window.addEventListener('scroll', handleNavHighlight);
    }

    async function init() {
        bindEvents();
        await Promise.all([
            loadStatus(),
            loadServers(),
            loadUsage(),
            loadProviders(),
            loadPlugins(),
            loadTools(),
            loadToolCalls(),
            loadLogs()
        ]);

        setInterval(loadStatus, 15000);
        setInterval(loadUsage, 60000);
        setInterval(loadToolCalls, 20000);
        setInterval(loadLogs, 15000);
    }

    init();
</script>
</body>
</html>