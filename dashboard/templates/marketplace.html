<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plugin Marketplace - OpenLLM Control Center</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='img/site-icon.svg') }}">
    <style>
        :root {
            --bg:#0b1120;
            --sidebar:#0f172a;
            --panel:#111c2e;
            --panel-border:#1f2a3e;
            --panel-hover:#16213e;
            --text:#f8fafc;
            --muted:#94a3b8;
            --accent:#7c3aed;
            --accent-soft:#6366f1;
            --success:#10b981;
            --danger:#ef4444;
            --warning:#f59e0b;
        }
        * {
            margin:0;
            padding:0;
            box-sizing:border-box;
        }
        html {
            scroll-behavior:smooth;
        }
        body {
            font-family:'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background:var(--bg);
            color:var(--text);
            min-height:100vh;
            display:flex;
            justify-content:center;
            padding:48px 24px;
        }
        .page {
            width:min(1140px, 100%);
            display:flex;
            flex-direction:column;
            gap:32px;
        }
        .card {
            background:var(--panel);
            border:1px solid var(--panel-border);
            border-radius:18px;
            padding:24px;
            box-shadow:0 24px 45px rgba(11,17,32,0.45);
        }
        .topbar {
            display:flex;
            justify-content:space-between;
            align-items:flex-start;
            gap:16px;
        }
        .topbar h1 {
            font-size:30px;
            font-weight:700;
            margin-bottom:10px;
        }
        .topbar-subtitle {
            color:var(--muted);
            line-height:1.5;
            max-width:640px;
        }
        .back-link {
            align-self:flex-start;
            padding:12px 20px;
            border-radius:999px;
            background:rgba(99,102,241,0.16);
            color:#c7d2fe;
            font-weight:600;
            text-decoration:none;
            transition:all 0.2s ease;
        }
        .back-link:hover {
            background:linear-gradient(135deg, var(--accent-soft), var(--accent));
            color:#fff;
            box-shadow:0 16px 30px rgba(99,102,241,0.25);
        }
        .search-card {
            display:flex;
            flex-direction:column;
            gap:18px;
        }
        .search-input {
            width:100%;
            padding:14px;
            border-radius:12px;
            border:1px solid rgba(148,163,184,0.16);
            background:#0f172a;
            color:var(--text);
            font-size:15px;
        }
        .search-input:focus {
            outline:none;
            border-color:var(--accent-soft);
            box-shadow:0 0 0 3px rgba(99,102,241,0.18);
        }
        .category-filter {
            display:flex;
            flex-wrap:wrap;
            gap:10px;
        }
        .category-btn {
            padding:8px 16px;
            border-radius:999px;
            border:1px solid rgba(148,163,184,0.2);
            background:rgba(148,163,184,0.12);
            color:var(--muted);
            font-size:13px;
            font-weight:600;
            cursor:pointer;
            transition:all 0.2s ease;
        }
        .category-btn:hover,
        .category-btn.active {
            background:linear-gradient(135deg, var(--accent-soft), var(--accent));
            color:#fff;
            border-color:transparent;
            box-shadow:0 12px 25px rgba(99,102,241,0.28);
        }
        .plugins-grid {
            display:grid;
            gap:22px;
            grid-template-columns:repeat(auto-fill, minmax(320px, 1fr));
        }
        .plugin-card {
            position:relative;
            transition:transform 0.2s ease, box-shadow 0.2s ease;
        }
        .plugin-card:hover {
            transform:translateY(-4px);
            box-shadow:0 32px 60px rgba(11,17,32,0.55);
        }
        .plugin-header {
            display:flex;
            gap:16px;
            align-items:flex-start;
            margin-bottom:18px;
        }
        .plugin-icon {
            width:56px;
            height:56px;
            border-radius:16px;
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:28px;
            background:linear-gradient(135deg, var(--accent-soft), var(--accent));
            box-shadow:0 16px 28px rgba(99,102,241,0.25);
            flex-shrink:0;
        }
        .plugin-info {
            flex:1;
        }
        .plugin-name {
            font-size:18px;
            font-weight:600;
            margin-bottom:4px;
        }
        .plugin-author {
            font-size:13px;
            color:var(--muted);
            margin-bottom:6px;
        }
        .plugin-version {
            font-size:12px;
            color:rgba(148,163,184,0.65);
            font-family:'JetBrains Mono','Fira Code',monospace;
        }
        .plugin-description {
            color:var(--muted);
            line-height:1.6;
            font-size:14px;
            margin-bottom:18px;
        }
        .plugin-tags {
            display:flex;
            flex-wrap:wrap;
            gap:8px;
            margin-bottom:18px;
        }
        .tag {
            padding:4px 12px;
            border-radius:999px;
            background:rgba(148,163,184,0.14);
            color:#cbd5f5;
            font-size:12px;
            font-weight:600;
        }
        .tag.builtin {
            background:linear-gradient(135deg, var(--accent-soft), var(--accent));
            color:#fff;
        }
        .plugin-stats {
            display:flex;
            flex-wrap:wrap;
            gap:16px;
            margin-bottom:18px;
            padding:12px 0;
            border-top:1px solid rgba(148,163,184,0.12);
            border-bottom:1px solid rgba(148,163,184,0.12);
            color:var(--muted);
            font-size:13px;
        }
        .stat {
            display:flex;
            align-items:center;
            gap:6px;
        }
        .plugin-actions {
            display:flex;
            gap:12px;
        }
        .btn {
            flex:1;
            padding:11px 18px;
            border-radius:999px;
            border:none;
            font-size:14px;
            font-weight:600;
            cursor:pointer;
            transition:transform 0.2s ease, box-shadow 0.2s ease;
        }
        .btn-primary {
            background:linear-gradient(135deg, var(--success), #0d9469);
            color:#fff;
            box-shadow:0 16px 30px rgba(16,185,129,0.25);
        }
        .btn-primary:hover:not(:disabled) {
            transform:translateY(-2px);
            box-shadow:0 22px 38px rgba(16,185,129,0.32);
        }
        .btn-disabled {
            background:rgba(148,163,184,0.16);
            color:var(--muted);
            cursor:default;
        }
        .btn-secondary {
            background:rgba(148,163,184,0.18);
            color:#cbd5f5;
            border:1px solid rgba(148,163,184,0.35);
        }
        .btn-secondary:hover {
            transform:translateY(-2px);
            background:rgba(148,163,184,0.28);
        }
        .empty-state {
            text-align:center;
            padding:80px 24px;
            color:var(--muted);
        }
        .empty-state-icon {
            font-size:54px;
            margin-bottom:18px;
            display:inline-block;
        }
        .toast {
            position:fixed;
            top:24px;
            right:24px;
            background:var(--panel);
            border:1px solid var(--panel-border);
            border-radius:16px;
            padding:16px 22px;
            box-shadow:0 24px 45px rgba(11,17,32,0.6);
            display:none;
            z-index:1000;
            color:var(--text);
        }
        .toast.show {
            display:block;
        }
        .toast.success {
            border-left:4px solid var(--success);
        }
        .toast.error {
            border-left:4px solid var(--danger);
        }
        @media (max-width:768px) {
            body {
                padding:24px 16px;
            }
            .page {
                gap:24px;
            }
            .topbar {
                flex-direction:column;
            }
            .plugin-actions {
                flex-direction:column;
            }
        }
    </style>
</head>
<body>
    <div class="page">
        <div class="topbar card">
            <div>
                <h1>Plugin Marketplace</h1>
                <p class="topbar-subtitle">
                    Discover community-built extensions and enrich your OpenLLM deployment with ready-to-use tools, automations, and integrations.
                </p>
            </div>
            <a class="back-link" href="/">‚Üê Back to Dashboard</a>
        </div>

        <div class="card search-card">
            <input type="text" id="searchInput" class="search-input" placeholder="Search plugins by name, description, or tag...">
            <div class="category-filter">
                <button class="category-btn active" data-category="all">All</button>
                <button class="category-btn" data-category="utility">Utility</button>
                <button class="category-btn" data-category="moderation">Moderation</button>
                <button class="category-btn" data-category="fun">Fun</button>
                <button class="category-btn" data-category="integration">Integration</button>
                <button class="category-btn" data-category="analytics">Analytics</button>
            </div>
        </div>

        <div class="plugins-grid" id="pluginsGrid"></div>

        <div class="card empty-state" id="emptyState" style="display:none;">
            <div class="empty-state-icon">üîç</div>
            <h2>No plugins found</h2>
            <p>Try adjusting your search terms or switching categories.</p>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        let plugins = [];
        let currentCategory = 'all';
        let searchQuery = '';

        // Load plugins from API
        async function loadPlugins() {
            try {
                const response = await fetch('/api/marketplace/plugins');
                const data = await response.json();
                plugins = data;
                renderPlugins();
            } catch (error) {
                console.error('Error loading plugins:', error);
                showToast('Failed to load plugins', 'error');
            }
        }

        function renderPlugins() {
            const grid = document.getElementById('pluginsGrid');
            const emptyState = document.getElementById('emptyState');
            
            let filteredPlugins = plugins.filter(plugin => {
                const matchesCategory = currentCategory === 'all' || plugin.category === currentCategory;
                const matchesSearch = searchQuery === '' || 
                    plugin.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    plugin.description.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    plugin.tags.some(tag => tag.toLowerCase().includes(searchQuery.toLowerCase()));
                
                return matchesCategory && matchesSearch;
            });

            if (filteredPlugins.length === 0) {
                grid.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            grid.style.display = 'grid';
            emptyState.style.display = 'none';

            grid.innerHTML = filteredPlugins.map(plugin => `
                <div class="card plugin-card" data-id="${plugin.id}">
                    <div class="plugin-header">
                        <div class="plugin-icon">${plugin.icon}</div>
                        <div class="plugin-info">
                            <div class="plugin-name">${plugin.name}</div>
                            <div class="plugin-author">by ${plugin.author}</div>
                            <div class="plugin-version">${plugin.version}</div>
                        </div>
                    </div>
                    <div class="plugin-description">${plugin.description}</div>
                    <div class="plugin-tags">
                        ${plugin.builtin ? '<span class="tag builtin">Built-in</span>' : ''}
                        ${plugin.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                    </div>
                    <div class="plugin-stats">
                        <div class="stat">üîß ${plugin.tools.length} tool${plugin.tools.length !== 1 ? 's' : ''}</div>
                        <div class="stat">üì¶ ${plugin.version}</div>
                    </div>
                    <div class="plugin-actions">
                        <button class="btn ${plugin.installed || plugin.builtin ? 'btn-disabled' : 'btn-primary'}" 
                                onclick="installPlugin('${plugin.id}')"
                                ${plugin.installed || plugin.builtin ? 'disabled' : ''}>
                            ${plugin.builtin ? '‚úì Built-in' : plugin.installed ? '‚úì Installed' : 'üì¶ Install'}
                        </button>
                        <button class="btn btn-secondary" onclick="showDetails('${plugin.id}')">Details</button>
                    </div>
                </div>
            `).join('');
        }

        async function installPlugin(pluginId) {
            const plugin = plugins.find(p => p.id === pluginId);
            if (!plugin || plugin.installed) return;

            // Show installing message
            showToast(`Installing ${plugin.name}...`, 'success');
            
            try {
                const response = await fetch(`/api/marketplace/install/${pluginId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    plugin.installed = true;
                    renderPlugins();
                    showToast(`${plugin.name} installed successfully!`, 'success');
                } else {
                    showToast(`Installation failed: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('Installation error:', error);
                showToast(`Installation failed: ${error.message}`, 'error');
            }
        }

        function showDetails(pluginId) {
            const plugin = plugins.find(p => p.id === pluginId);
            if (!plugin) return;

            const toolsList = plugin.tools.map(t => `- ${t.name}: ${t.description}`).join('\n');
            alert(`Plugin: ${plugin.name}\nVersion: ${plugin.version}\nAuthor: ${plugin.author}\n\n${plugin.description}\n\nTools:\n${toolsList}\n\nCategory: ${plugin.category}`);
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('input', (e) => {
            searchQuery = e.target.value;
            renderPlugins();
        });

        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                currentCategory = e.target.dataset.category;
                renderPlugins();
            });
        });

        // Initial load
        loadPlugins();
    </script>
</body>
</html>
